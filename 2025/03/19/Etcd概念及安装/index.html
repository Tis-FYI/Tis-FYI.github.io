

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="TAO">
  <meta name="keywords" content="">
  
    <meta name="description" content="1. etcd概念1.1. etcd介绍etcd的名字来源于&#x2F;etc和distibuted，即Unix下配置文件目录和分布式两个关键词。Etcd是一个分布式、可靠的k-v分布式数据库，同时还能提供配置共享、服务发现等功能，常常用在go语言的项目中。etcd主要有以下几个方面的特点：  部署简单：只有一个二进制文件，可以开箱即用 使用简单：etcd有着丰富的client SDK 安全性高：支持SSL">
<meta property="og:type" content="article">
<meta property="og:title" content="Etcd概念及安装">
<meta property="og:url" content="https://blog.t-ao.cn/2025/03/19/Etcd%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%89%E8%A3%85/index.html">
<meta property="og:site_name" content="TAO&#39;s Blog">
<meta property="og:description" content="1. etcd概念1.1. etcd介绍etcd的名字来源于&#x2F;etc和distibuted，即Unix下配置文件目录和分布式两个关键词。Etcd是一个分布式、可靠的k-v分布式数据库，同时还能提供配置共享、服务发现等功能，常常用在go语言的项目中。etcd主要有以下几个方面的特点：  部署简单：只有一个二进制文件，可以开箱即用 使用简单：etcd有着丰富的client SDK 安全性高：支持SSL">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-19T03:11:21.000Z">
<meta property="article:modified_time" content="2025-03-19T03:35:02.607Z">
<meta property="article:author" content="TAO">
<meta property="article:tag" content="云原生Etcd">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Etcd概念及安装 - TAO&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.t-ao.cn","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>T-AO</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>文章</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>常用站点</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Etcd概念及安装"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-19 11:11" pubdate>
          2025年3月19日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          46 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Etcd概念及安装</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="1-etcd概念"><a href="#1-etcd概念" class="headerlink" title="1. etcd概念"></a>1. etcd概念</h1><h2 id="1-1-etcd介绍"><a href="#1-1-etcd介绍" class="headerlink" title="1.1. etcd介绍"></a>1.1. etcd介绍</h2><p>etcd的名字来源于<code>/etc</code>和<code>distibuted</code>，即Unix下配置文件目录和分布式两个关键词。Etcd是一个分布式、可靠的k-v分布式数据库，同时还能提供配置共享、服务发现等功能，常常用在go语言的项目中。etcd主要有以下几个方面的特点：</p>
<ul>
<li>部署简单：只有一个二进制文件，可以开箱即用</li>
<li>使用简单：etcd有着丰富的client SDK</li>
<li>安全性高：支持SSL证书认证，数据加密，节点之间相互验证身份</li>
<li>强一致性：通过raft算法实现数据的强一致性，少于二分之一节点宕机仍然能提供服务，通常部署3个或者5个节点</li>
<li>数据落地：etcd的数据会通过wal格式的数据持久化到磁盘，并且支持snapshot快照</li>
</ul>
<p>etcd的架构主要由以下四个部分：</p>
<ul>
<li>HTTP Server：请求的入口，用来处理各种API请求</li>
<li>Store：用于处理etcd支持的各类功能的事务，包括数据索引、节点状态变更、监控与反馈、事件处理与执行等等，是etcd对用户提供的大多数API功能的具体实现</li>
<li>Raft状态机：实现多节点的etcd集群中数据一致性和节点选主</li>
<li>WAL：Write Ahead Log（预写式日志），是etcd的数据存储方式。除了在内存中存有所有数据的状态以及节点的索引以外，etcd就通过WAL进行持久化存储。WAL中，所有的数据提交前都会事先记录日志。Snapshot是为了防止数据过多而进行的状态快照；Entry表示存储的具体日志内容。</li>
</ul>
<h2 id="1-2-Raft"><a href="#1-2-Raft" class="headerlink" title="1.2. Raft"></a>1.2. Raft</h2><p>Raft 是etcd保障分布式节点中数据一致性的关键，该算法本身有一定的复杂度。网上有很多etcd的raft算法的博客，详细介绍了节点直接如何选主、如何同步数据、如何补偿数据的。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5aed73b288f7">ETCD背后的Raft一致性算法原理</a></li>
<li>[分布式一致性算法 Raft 和 Etcd 原理解析](<a target="_blank" rel="noopener" href="http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%9E%E8%B7%B5%E4%B9%8B%E8%B7%AF%EF%BC%88%E5%AE%8C%EF%BC%89/09">http://learn.lianglianglee.com/专栏/分布式中间件实践之路（完）/09</a> 分布式一致性算法 Raft 和 Etcd 原理解析.md)</li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xybaby/p/10124083.html">一文搞懂Raft算法</a></li>
</ul>
<hr>
<h1 id="2-etcd部署"><a href="#2-etcd部署" class="headerlink" title="2. etcd部署"></a>2. etcd部署</h1><h2 id="2-1-准备工作"><a href="#2-1-准备工作" class="headerlink" title="2.1. 准备工作"></a>2.1. 准备工作</h2><h3 id="2-1-1-硬件需求"><a href="#2-1-1-硬件需求" class="headerlink" title="2.1.1. 硬件需求"></a>2.1.1. 硬件需求</h3><p>这里简单介绍下ectd对硬件的要求，详情需要参考<a target="_blank" rel="noopener" href="https://etcd.io/docs/v3.5/op-guide/hardware/">官方文档</a>。</p>
<ol>
<li>CPU</li>
</ol>
<p>etcd对CPU的消耗不是很大，通常需要2-4个核心即可。在高负载集群下，如同时给上千个客户端提供服务，或者每秒有上万个请求的场景，需要8-16核心。一般规模，可以先使用2-4核心的CPU，后续如果CPU使用率较高，可以逐个节点升级配置。</p>
<ol>
<li>Memory</li>
</ol>
<p>etcd对内存的需求不是很大，但是也会积极的缓存k-v数据到内存，并用剩余的内存跟踪watcher。一般而言，8G内存也足够了。</p>
<ol>
<li>Disk</li>
</ol>
<p>磁盘的写入速度是影响etcd性能的关键，etcd的raft共识协议依赖于将元数据写入到日志中，每个etcd节点都要将每个请求写入磁盘。并且，etcd还需要将增量的checkpoint写入磁盘，用来截断日志。如果写入时间过长，可能因为超过心跳时间造成集群重新选举，从而破坏集群的稳定性。在检查磁盘性能的时候，可以使用 fio 进行测试，具体可以参考<a target="_blank" rel="noopener" href="https://www.ibm.com/cloud/blog/using-fio-to-tell-whether-your-storage-is-fast-enough-for-etcd">IBM的这篇文章</a>。</p>
<p>磁盘的性能要从两个方面去评估，第一个是IOPS能力：一般而言，需要50顺序IOPS的速度(比如7200RPM的机械盘)，高负载集群需要500顺序IOPS速度(通常是固态)。第二个是磁盘带宽，这个决定了新节点或者失败节点同步数据的时间，典型的10MB&#x2F;s的磁盘通常在15秒内能恢复100MB数据，100MB&#x2F;s可以在15秒内恢复1GB的数据。</p>
<p>etcd的数据会相互同步，不要担心节点坏盘问题，因此没必要做RAID5这种RAID10，如果需要做RAID提升磁盘性能，请考虑使用RAID0。</p>
<ol>
<li>Network</li>
</ol>
<p>etcd集群需要快速网络，并且保障网络的稳定性，通常1GbE的内部网络可以满足大部分场景的需求，通常建议将etcd节点部署到一个网络域内，减少跨网络的延迟。</p>
<p>etcd官方文档还提供了，不同规模下的kubernetes的对etcd集群配置的要求，需要注意的是，这些集群中etcd是单独部署的，并不是和master节点共用。</p>
<ol>
<li>小集群</li>
</ol>
<p>请求客户端少于100个，每秒请求少于200个，并且存储数据少于100MB。如50个node的kuberentes集群：</p>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Type</th>
<th>vCPUs</th>
<th>Memory (GB)</th>
<th>Max concurrent IOPS</th>
<th>Disk bandwidth (MB&#x2F;s)</th>
</tr>
</thead>
<tbody><tr>
<td>AWS</td>
<td>m4.large</td>
<td>2</td>
<td>8</td>
<td>3600</td>
<td>56.25</td>
</tr>
<tr>
<td>GCE</td>
<td>n1-standard-2 + 50GB PD SSD</td>
<td>2</td>
<td>7.5</td>
<td>1500</td>
<td>25</td>
</tr>
</tbody></table>
<ol>
<li>中等规模集群</li>
</ol>
<p>请求客户端少于500个，每秒请求少于1000个，并且存储数据少于500MB。如250个node的kuberentes集群：</p>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Type</th>
<th>vCPUs</th>
<th>Memory (GB)</th>
<th>Max concurrent IOPS</th>
<th>Disk bandwidth (MB&#x2F;s)</th>
</tr>
</thead>
<tbody><tr>
<td>AWS</td>
<td>m4.xlarge</td>
<td>4</td>
<td>16</td>
<td>6000</td>
<td>93.75</td>
</tr>
<tr>
<td>GCE</td>
<td>n1-standard-4 + 150GB PD SSD</td>
<td>4</td>
<td>15</td>
<td>4500</td>
<td>75</td>
</tr>
</tbody></table>
<ol>
<li>大规模集群</li>
</ol>
<p>请求客户端少于1500个，每秒请求少于10000个，并且存储数据少于1000MB。如1000个node的kuberentes集群</p>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Type</th>
<th>vCPUs</th>
<th>Memory (GB)</th>
<th>Max concurrent IOPS</th>
<th>Disk bandwidth (MB&#x2F;s)</th>
</tr>
</thead>
<tbody><tr>
<td>AWS</td>
<td>m4.2xlarge</td>
<td>8</td>
<td>32</td>
<td>8000</td>
<td>125</td>
</tr>
<tr>
<td>GCE</td>
<td>n1-standard-8 + 250GB PD SSD</td>
<td>8</td>
<td>30</td>
<td>7500</td>
<td>125</td>
</tr>
</tbody></table>
<ol>
<li>超大规模集群</li>
</ol>
<p>请求客户端超过1500个，每秒请求超过10000个，并且存储数据大于1000MB。如3000个node的kuberentes集群</p>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Type</th>
<th>vCPUs</th>
<th>Memory (GB)</th>
<th>Max concurrent IOPS</th>
<th>Disk bandwidth (MB&#x2F;s)</th>
</tr>
</thead>
<tbody><tr>
<td>AWS</td>
<td>m4.4xlarge</td>
<td>16</td>
<td>64</td>
<td>16,000</td>
<td>250</td>
</tr>
<tr>
<td>GCE</td>
<td>n1-standard-16 + 500GB PD SSD</td>
<td>16</td>
<td>60</td>
<td>15,000</td>
<td>250</td>
</tr>
</tbody></table>
<h3 id="2-1-2-机器规划"><a href="#2-1-2-机器规划" class="headerlink" title="2.1.2. 机器规划"></a>2.1.2. 机器规划</h3><p>规划小规模测试集群，集群中节均关闭swap分区，安装chronyd时间同步服务。</p>
<p>磁盘写入性能由 fio 测试得出，具体可以参考<a target="_blank" rel="noopener" href="https://www.ibm.com/cloud/blog/using-fio-to-tell-whether-your-storage-is-fast-enough-for-etcd">IBM的这篇文章</a>。</p>
<table>
<thead>
<tr>
<th>节点</th>
<th>IP</th>
<th>系统</th>
<th>CPU&#x2F;Memory</th>
<th>Disk</th>
<th>write IOPS avg</th>
<th>write bandwidth avg(MB&#x2F;s)</th>
</tr>
</thead>
<tbody><tr>
<td>etcd-1</td>
<td>10.4.7.121</td>
<td>ubuntu 18.04.5</td>
<td>2C 4G</td>
<td>20G SSD</td>
<td>min&#x3D; 2706, max&#x3D; 2758, avg&#x3D;2727.14</td>
<td>min&#x3D; 6077, max&#x3D; 6194,avg&#x3D;6124.86</td>
</tr>
<tr>
<td>etcd-2</td>
<td>10.4.7.122</td>
<td>ubuntu 18.04.5</td>
<td>2C 4G</td>
<td>20G SSD</td>
<td></td>
<td></td>
</tr>
<tr>
<td>etcd-3</td>
<td>10.4.7.123</td>
<td>ubuntu 18.04.5</td>
<td>2C 4G</td>
<td>20G SSD</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="2-2-etcd集群部署"><a href="#2-2-etcd集群部署" class="headerlink" title="2.2. etcd集群部署"></a>2.2. etcd集群部署</h2><p>ectd 版本下载页面：<a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases%EF%BC%8C%E8%BF%99%E9%87%8C%E4%BB%A5">https://github.com/etcd-io/etcd/releases，这里以</a> 3.5.1 版本为例，进行安装和学习。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@duduniao etcd]# wget https://github.com/etcd-io/etcd/releases/download/v3.5.1/etcd-v3.5.1-linux-amd64.tar.gz<br>[root@duduniao etcd]# tar -xf etcd-v3.5.1-linux-amd64.tar.gz<br>[root@duduniao etcd]# ls etcd-v3.5.1-linux-amd64/etcd* -l<br>-rwxr-xr-x 1 114762 114762 23568384 Oct 15 22:22 etcd-v3.5.1-linux-amd64/etcd<br>-rwxr-xr-x 1 114762 114762 17981440 Oct 15 22:22 etcd-v3.5.1-linux-amd64/etcdctl<br>-rwxr-xr-x 1 114762 114762 16056320 Oct 15 22:22 etcd-v3.5.1-linux-amd64/etcdutl<br><br># 下发etcd软件到各个服务器上<br>[root@duduniao etcd]# scan_host.sh push -h 10.4.7.121 10.4.7.122 10.4.7.123 etcd-v3.5.1-linux-amd64/etcd* /usr/local/bin/<br>10.4.7.123        etcd-v3.5.1-linux-amd64/etcd etcd-v3.5.1-linux-amd64/etcdctl etcd-v3.5.1-linux-amd64/etcdutl --&gt; /usr/local/bin/ Y<br>10.4.7.121        etcd-v3.5.1-linux-amd64/etcd etcd-v3.5.1-linux-amd64/etcdctl etcd-v3.5.1-linux-amd64/etcdutl --&gt; /usr/local/bin/ Y<br>10.4.7.122        etcd-v3.5.1-linux-amd64/etcd etcd-v3.5.1-linux-amd64/etcdctl etcd-v3.5.1-linux-amd64/etcdutl --&gt; /usr/local/bin/ Y<br><br># 配置启动的etcd.service文件<br>[root@duduniao etcd]# scp etcd-1.service 10.4.7.121:/lib/systemd/system/etcd.service<br>[root@duduniao etcd]# scp etcd-2.service 10.4.7.122:/lib/systemd/system/etcd.service<br>[root@duduniao etcd]# scp etcd-3.service 10.4.7.123:/lib/systemd/system/etcd.service<br><br># 启动etcd<br>[root@duduniao etcd]# scan_host.sh cmd -h 10.4.7.121 10.4.7.122 10.4.7.123 &quot;mkdir /data/etcd ; systemctl daemon-reload&quot;<br>[root@duduniao etcd]# scan_host.sh cmd -h 10.4.7.121 10.4.7.122 10.4.7.123 &quot;systemctl start etcd &amp;&amp; systemctl enable etcd&quot;<br>[root@duduniao etcd]# scan_host.sh cmd -h 10.4.7.121 10.4.7.122 10.4.7.123 &quot;systemctl is-enabled etcd &amp;&amp; systemctl is-active etcd&quot;<br><br># 检查集群状态<br>[root@duduniao etcd]# ./etcd-v3.5.1-linux-amd64/etcdctl --endpoints=10.4.7.121:2379 member list --write-out=table<br>+------------------+---------+--------+------------------------+------------------------+------------+<br>|        ID        | STATUS  |  NAME  |       PEER ADDRS       |      CLIENT ADDRS      | IS LEARNER |<br>+------------------+---------+--------+------------------------+------------------------+------------+<br>| 4c45db44e1021917 | started | etcd-1 | http://10.4.7.121:2380 | http://10.4.7.121:2379 |      false |<br>| 721eef2714f1477a | started | etcd-2 | http://10.4.7.122:2380 | http://10.4.7.122:2379 |      false |<br>| f6d5f5c8eef4f092 | started | etcd-3 | http://10.4.7.123:2380 | http://10.4.7.123:2379 |      false |<br>+------------------+---------+--------+------------------------+------------------------+------------+<br><br># 测试读写<br>[root@duduniao etcd]# ./etcd-v3.5.1-linux-amd64/etcdctl --endpoints=10.4.7.121:2379 put k1 test-value-1<br>[root@duduniao etcd]# ./etcd-v3.5.1-linux-amd64/etcdctl --endpoints=10.4.7.123:2379 get k1<br>k1<br>test-value-1<br># etcd-1.service<br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br>Documentation=https://github.com/coreos<br><br>[Service]<br>Type=notify<br>WorkingDirectory=/data/etcd<br>ExecStart=/usr/local/bin/etcd \<br>  --name etcd-1 \<br>  --initial-advertise-peer-urls http://10.4.7.121:2380 \<br>  --listen-peer-urls http://10.4.7.121:2380 \<br>  --listen-client-urls http://10.4.7.121:2379,http://127.0.0.1:2379 \<br>  --advertise-client-urls http://10.4.7.121:2379 \<br>  --initial-cluster-token etcd-cluster-1 \<br>  --initial-cluster etcd-1=http://10.4.7.121:2380,etcd-2=http://10.4.7.122:2380,etcd-3=http://10.4.7.123:2380 \<br>  --initial-cluster-state new \<br>  --data-dir /data/etcd \<br>  --snapshot-count 50000 \<br>  --auto-compaction-retention 1 \<br>  --auto-compaction-mode periodic \<br>  --max-request-bytes 10485760 \<br>  --quota-backend-bytes 8589934592<br>Restart=always<br>RestartSec=15<br>LimitNOFILE=65536<br>OOMScoreAdjust=-999<br><br>[Install]<br>WantedBy=multi-user.target<br><br># etcd-2.service<br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br>Documentation=https://github.com/coreos<br><br>[Service]<br>Type=notify<br>WorkingDirectory=/data/etcd<br>ExecStart=/usr/local/bin/etcd \<br>  --name etcd-2 \<br>  --initial-advertise-peer-urls http://10.4.7.122:2380 \<br>  --listen-peer-urls http://10.4.7.122:2380 \<br>  --listen-client-urls http://10.4.7.122:2379,http://127.0.0.1:2379 \<br>  --advertise-client-urls http://10.4.7.122:2379 \<br>  --initial-cluster-token etcd-cluster-1 \<br>  --initial-cluster etcd-1=http://10.4.7.121:2380,etcd-2=http://10.4.7.122:2380,etcd-3=http://10.4.7.123:2380 \<br>  --initial-cluster-state new \<br>  --data-dir /data/etcd \<br>  --snapshot-count 50000 \<br>  --auto-compaction-retention 1 \<br>  --auto-compaction-mode periodic \<br>  --max-request-bytes 10485760 \<br>  --quota-backend-bytes 8589934592<br>Restart=always<br>RestartSec=15<br>LimitNOFILE=65536<br>OOMScoreAdjust=-999<br><br>[Install]<br>WantedBy=multi-user.target<br><br># etcd-3.service<br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br>Documentation=https://github.com/coreos<br><br>[Service]<br>Type=notify<br>WorkingDirectory=/data/etcd<br>ExecStart=/usr/local/bin/etcd \<br>  --name etcd-3 \<br>  --initial-advertise-peer-urls http://10.4.7.123:2380 \<br>  --listen-peer-urls http://10.4.7.123:2380 \<br>  --listen-client-urls http://10.4.7.123:2379,http://127.0.0.1:2379 \<br>  --advertise-client-urls http://10.4.7.123:2379 \<br>  --initial-cluster-token etcd-cluster-1 \<br>  --initial-cluster etcd-1=http://10.4.7.121:2380,etcd-2=http://10.4.7.122:2380,etcd-3=http://10.4.7.123:2380 \<br>  --initial-cluster-state new \<br>  --data-dir /data/etcd \<br>  --snapshot-count 50000 \<br>  --auto-compaction-retention 1 \<br>  --auto-compaction-mode periodic \<br>  --max-request-bytes 10485760 \<br>  --quota-backend-bytes 8589934592<br>Restart=always<br>RestartSec=15<br>LimitNOFILE=65536<br>OOMScoreAdjust=-999<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<h2 id="2-3-TLS加密通信的etcd集群部署"><a href="#2-3-TLS加密通信的etcd集群部署" class="headerlink" title="2.3. TLS加密通信的etcd集群部署"></a>2.3. TLS加密通信的etcd集群部署</h2><p>etcd有两个对外暴露的端口：2379 和 2380。其中2379是的用来接收客户端请求的，2380用来和集群内部其它节点通信和数据同步的。这两种通信都可以进行TLS加密，并且可以使用CA证书进行验证对方是否合法。etcd默认是没用启动RBAC认证的，所有连接上的客户端都是可以操作所有的key。在k8s集群中，ectd服务端是通过客户端证书验证是否合法的，只有客户端拿etcd认可的CA签发的证书才能通过认证。核心参数如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plain"># client和server直接通信<br>--trusted-ca-file=&lt;path&gt;			受信任的CA证书<br>--cert-file=&lt;path&gt;						etcd 服务端证书<br>--key-file=&lt;path&gt;							etcd 服务端证书私钥<br>--client-cert-auth						指定该参数后，服务端要求客户端证书也是trusted-ca-file签发的证书<br><br># etcd节点之间通信(peer)<br>--peer-trusted-ca-file=&lt;path&gt;	受信任的CA证书<br>--peer-cert-file=&lt;path&gt;				etcd 服务端证书<br>--peer-key-file=&lt;path&gt;				etcd 服务端证书私钥<br>--peer-client-cert-auth				指定该参数后，要求对端证书也是peer-trusted-ca-file签发的证书<br></code></pre></td></tr></table></figure>

<h3 id="2-3-1-签发证书"><a href="#2-3-1-签发证书" class="headerlink" title="2.3.1. 签发证书"></a>2.3.1. 签发证书</h3><p>通常我们会同时加密 client-server 以及 peer 节点证书，为了简化，client-server 和 peer 的ca证书通常是相同的，甚至peer证书和server证书都可以相同。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 下载证书签发工具<br>[root@duduniao etcd]# wget -O /usr/local/bin/cfssl  https://pkg.cfssl.org/R1.2/cfssl_linux-amd64<br>[root@duduniao etcd]# wget -O /usr/local/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64<br>[root@duduniao etcd]# chmod +x /usr/local/bin/cfssljson  /usr/local/bin/cfssl<br># 签发ca证书，这里有个很大的坑：<br>#     etcd节点会不断以客户端身份访问自身的2379端口，并且使用的是server证书，因此ca的server配置必须添加line:19 &quot;client auth&quot;。否则会报以下错误:<br>#     WARNING: 2021/10/17 09:55:56 [core] grpc: addrConn.createTransport failed to connect to &#123;127.0.0.1:2379 127.0.0.1:2379 &lt;nil&gt; 0 &lt;nil&gt;&#125;. <br>#     Err: connection error: desc = &quot;transport: authentication handshake failed: remote error: tls: bad certificate&quot;. Reconnecting...<br>[root@duduniao etcd]# mkdir ssl/ &amp;&amp; cd ssl<br>[root@duduniao ssl]# cat ca-config.json<br>&#123;<br>    &quot;signing&quot;: &#123;<br>        &quot;default&quot;: &#123;<br>            &quot;expiry&quot;: &quot;43800h&quot;<br>        &#125;,<br>        &quot;profiles&quot;: &#123;<br>            &quot;server&quot;: &#123;<br>                &quot;expiry&quot;: &quot;43800h&quot;,<br>                &quot;usages&quot;: [<br>                    &quot;signing&quot;,<br>                    &quot;key encipherment&quot;,<br>                    &quot;server auth&quot;,<br>                    &quot;client auth&quot;<br>                ]<br>            &#125;,<br>            &quot;client&quot;: &#123;<br>                &quot;expiry&quot;: &quot;43800h&quot;,<br>                &quot;usages&quot;: [<br>                    &quot;signing&quot;,<br>                    &quot;key encipherment&quot;,<br>                    &quot;client auth&quot;<br>                ]<br>            &#125;,<br>            &quot;peer&quot;: &#123;<br>                &quot;expiry&quot;: &quot;43800h&quot;,<br>                &quot;usages&quot;: [<br>                    &quot;signing&quot;,<br>                    &quot;key encipherment&quot;,<br>                    &quot;server auth&quot;,<br>                    &quot;client auth&quot;<br>                ]<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br>[root@duduniao ssl]# cat ca-csr.json<br>&#123;<br>    &quot;CN&quot;: &quot;local-etcd-ca&quot;,<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;Shanghai&quot;,<br>            &quot;O&quot;: &quot;duduniao&quot;,<br>            &quot;ST&quot;: &quot;Shanghai&quot;,<br>            &quot;OU&quot;: &quot;devops&quot;<br>        &#125;<br>    ]<br>&#125;<br>[root@duduniao ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -<br>[root@duduniao ssl]# ll<br>total 20<br>-rw-r--r-- 1 root root  832 2021-10-17 15:23:33 ca-config.json<br>-rw-r--r-- 1 root root  274 2021-10-17 15:26:46 ca-csr.json<br>-rw------- 1 root root 1679 2021-10-17 15:27:08 ca-key.pem<br>-rw-r--r-- 1 root root 1013 2021-10-17 15:27:08 ca.csr<br>-rw-r--r-- 1 root root 1387 2021-10-17 15:27:08 ca.pem<br># 签发server证书， client验证server使用，同时server自检也需要<br>[root@duduniao ssl]# cat server.json<br>&#123;<br>    &quot;CN&quot;: &quot;local-etcd.duduniao.com&quot;,<br>    &quot;hosts&quot;: [<br>        &quot;10.4.7.121&quot;,<br>        &quot;10.4.7.122&quot;,<br>        &quot;10.4.7.123&quot;,<br>        &quot;127.0.0.1&quot;,<br>        &quot;etcd-1&quot;,<br>        &quot;etcd-2&quot;,<br>        &quot;etcd-3&quot;,<br>        &quot;localhost&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;ecdsa&quot;,<br>        &quot;size&quot;: 256<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;Shanghai&quot;,<br>            &quot;ST&quot;: &quot;Shanghai&quot;<br>        &#125;<br>    ]<br>&#125;<br>[root@duduniao ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server server.json | cfssljson -bare server<br>[root@duduniao ssl]# ll server*<br>-rw------- 1 root root  227 2021-10-17 15:32:56 server-key.pem<br>-rw-r--r-- 1 root root  558 2021-10-17 15:32:56 server.csr<br>-rw-r--r-- 1 root root  391 2021-10-17 15:32:24 server.json<br>-rw-r--r-- 1 root root 1184 2021-10-17 15:32:56 server.pem<br># 签发peer证书，推荐每个节点一个, 以etcd-1为例，其它节点修改IP、域名和主机名<br>[root@duduniao ssl]# cat etcd-1.json<br>&#123;<br>    &quot;CN&quot;: &quot;local-etcd-1.duduniao.com&quot;,<br>    &quot;hosts&quot;: [<br>        &quot;10.4.7.121&quot;,<br>        &quot;etcd-1&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;ecdsa&quot;,<br>        &quot;size&quot;: 256<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;Shanghai&quot;,<br>            &quot;ST&quot;: &quot;Shanghai&quot;<br>        &#125;<br>    ]<br>&#125;<br>[root@duduniao ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-1.json | cfssljson -bare etcd-1<br>[root@duduniao ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-2.json | cfssljson -bare etcd-2<br>[root@duduniao ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-3.json | cfssljson -bare etcd-3<br></code></pre></td></tr></table></figure>

<h3 id="2-3-2-部署etcd集群"><a href="#2-3-2-部署etcd集群" class="headerlink" title="2.3.2. 部署etcd集群"></a>2.3.2. 部署etcd集群</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 停止掉非加密的etcd集群，清理etcd数据<br>[root@duduniao etcd]# scan_host.sh cmd -h 10.4.7.121 10.4.7.122 10.4.7.123 &quot;systemctl stop etcd&quot; <br>[root@duduniao etcd]# scan_host.sh cmd -h 10.4.7.121 10.4.7.122 10.4.7.123 &quot;rm -fr /data/etcd&quot;<br># 下发证书<br>[root@duduniao etcd]# scan_host.sh cmd -h 10.4.7.121 10.4.7.122 10.4.7.123 &quot;mkdir -p /data/etcd/data /data/etcd/ssl&quot;<br>[root@duduniao etcd]# scan_host.sh push -h 10.4.7.121 10.4.7.122 10.4.7.123 ssl/ca.pem ssl/server.pem ssl/server-key.pem  /data/etcd/ssl/<br>[root@duduniao etcd]# scp ssl/etcd-1-key.pem ssl/etcd-1.pem 10.4.7.121:/data/etcd/ssl/<br>[root@duduniao etcd]# scp ssl/etcd-2-key.pem ssl/etcd-2.pem 10.4.7.122:/data/etcd/ssl/<br>[root@duduniao etcd]# scp ssl/etcd-3-key.pem ssl/etcd-3.pem 10.4.7.123:/data/etcd/ssl/<br>[root@duduniao etcd]# scan_host.sh cmd -h 10.4.7.121 10.4.7.122 10.4.7.123 &quot;ls -l /data/etcd/ssl&quot;<br>10.4.7.122<br>total 20<br>-rw-r--r-- 1 root root 1387 Oct 17 07:53 ca.pem<br>-rw------- 1 root root  227 Oct 17 07:54 etcd-2-key.pem<br>-rw-r--r-- 1 root root 1147 Oct 17 07:54 etcd-2.pem<br>-rw------- 1 root root  227 Oct 17 07:53 server-key.pem<br>-rw-r--r-- 1 root root 1184 Oct 17 07:53 server.pem<br>10.4.7.121<br>total 20<br>-rw-r--r-- 1 root root 1387 Oct 17 07:53 ca.pem<br>-rw------- 1 root root  227 Oct 17 07:54 etcd-1-key.pem<br>-rw-r--r-- 1 root root 1147 Oct 17 07:54 etcd-1.pem<br>-rw------- 1 root root  227 Oct 17 07:53 server-key.pem<br>-rw-r--r-- 1 root root 1184 Oct 17 07:53 server.pem<br>10.4.7.123<br>total 20<br>-rw-r--r-- 1 root root 1387 Oct 17 07:53 ca.pem<br>-rw------- 1 root root  227 Oct 17 07:55 etcd-3-key.pem<br>-rw-r--r-- 1 root root 1147 Oct 17 07:55 etcd-3.pem<br>-rw------- 1 root root  227 Oct 17 07:53 server-key.pem<br>-rw-r--r-- 1 root root 1184 Oct 17 07:53 server.pem<br># 修改servcie文件<br># etcd-1.service<br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br>Documentation=https://github.com/coreos<br><br>[Service]<br>Type=notify<br>WorkingDirectory=/data/etcd<br>ExecStart=/usr/local/bin/etcd \<br>  --name etcd-1 \<br>  --initial-advertise-peer-urls https://10.4.7.121:2380 \<br>  --listen-peer-urls https://10.4.7.121:2380 \<br>  --listen-client-urls https://10.4.7.121:2379,https://127.0.0.1:2379 \<br>  --advertise-client-urls https://10.4.7.121:2379 \<br>  --initial-cluster-token etcd-cluster-1 \<br>  --initial-cluster etcd-1=https://10.4.7.121:2380,etcd-2=https://10.4.7.122:2380,etcd-3=https://10.4.7.123:2380 \<br>  --initial-cluster-state new \<br>  --client-cert-auth \<br>  --cert-file ssl/server.pem \<br>  --key-file ssl/server-key.pem \<br>  --trusted-ca-file ssl/ca.pem \<br>  --peer-client-cert-auth \<br>  --peer-trusted-ca-file ssl/ca.pem \<br>  --peer-cert-file ssl/etcd-1.pem \<br>  --peer-key-file ssl/etcd-1-key.pem \<br>  --data-dir data \<br>  --snapshot-count 50000 \<br>  --auto-compaction-retention 1 \<br>  --auto-compaction-mode periodic \<br>  --max-request-bytes 10485760 \<br>  --quota-backend-bytes 8589934592<br>Restart=always<br>RestartSec=15<br>LimitNOFILE=65536<br>OOMScoreAdjust=-999<br><br>[Install]<br>WantedBy=multi-user.target<br><br># etcd-2.service<br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br>Documentation=https://github.com/coreos<br><br>[Service]<br>Type=notify<br>WorkingDirectory=/data/etcd<br>ExecStart=/usr/local/bin/etcd \<br>  --name etcd-2 \<br>  --initial-advertise-peer-urls https://10.4.7.122:2380 \<br>  --listen-peer-urls https://10.4.7.122:2380 \<br>  --listen-client-urls https://10.4.7.122:2379,https://127.0.0.1:2379 \<br>  --advertise-client-urls https://10.4.7.122:2379 \<br>  --initial-cluster-token etcd-cluster-1 \<br>  --initial-cluster etcd-1=https://10.4.7.121:2380,etcd-2=https://10.4.7.122:2380,etcd-3=https://10.4.7.123:2380 \<br>  --initial-cluster-state new \<br>  --client-cert-auth \<br>  --cert-file ssl/server.pem \<br>  --key-file ssl/server-key.pem \<br>  --trusted-ca-file ssl/ca.pem \<br>  --peer-client-cert-auth \<br>  --peer-trusted-ca-file ssl/ca.pem \<br>  --peer-cert-file ssl/etcd-2.pem \<br>  --peer-key-file ssl/etcd-2-key.pem \<br>  --data-dir data \<br>  --snapshot-count 50000 \<br>  --auto-compaction-retention 1 \<br>  --auto-compaction-mode periodic \<br>  --max-request-bytes 10485760 \<br>  --quota-backend-bytes 8589934592<br>Restart=always<br>RestartSec=15<br>LimitNOFILE=65536<br>OOMScoreAdjust=-999<br><br>[Install]<br>WantedBy=multi-user.target<br><br># etcd-3.service<br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br>Documentation=https://github.com/coreos<br><br>[Service]<br>Type=notify<br>WorkingDirectory=/data/etcd<br>ExecStart=/usr/local/bin/etcd \<br>  --name etcd-3 \<br>  --initial-advertise-peer-urls https://10.4.7.123:2380 \<br>  --listen-peer-urls https://10.4.7.123:2380 \<br>  --listen-client-urls https://10.4.7.123:2379,https://127.0.0.1:2379 \<br>  --advertise-client-urls https://10.4.7.123:2379 \<br>  --initial-cluster-token etcd-cluster-1 \<br>  --initial-cluster etcd-1=https://10.4.7.121:2380,etcd-2=https://10.4.7.122:2380,etcd-3=https://10.4.7.123:2380 \<br>  --initial-cluster-state new \<br>  --client-cert-auth \<br>  --cert-file ssl/server.pem \<br>  --key-file ssl/server-key.pem \<br>  --trusted-ca-file ssl/ca.pem \<br>  --peer-client-cert-auth \<br>  --peer-trusted-ca-file ssl/ca.pem \<br>  --peer-cert-file ssl/etcd-3.pem \<br>  --peer-key-file ssl/etcd-3-key.pem \<br>  --data-dir data \<br>  --snapshot-count 50000 \<br>  --auto-compaction-retention 1 \<br>  --auto-compaction-mode periodic \<br>  --max-request-bytes 10485760 \<br>  --quota-backend-bytes 8589934592<br>Restart=always<br>RestartSec=15<br>LimitNOFILE=65536<br>OOMScoreAdjust=-999<br><br>[Install]<br>WantedBy=multi-user.target<br># 启动集群<br>[root@duduniao etcd]# scp etcd-1.service 10.4.7.121:/lib/systemd/system/etcd.service<br>[root@duduniao etcd]# scp etcd-2.service 10.4.7.122:/lib/systemd/system/etcd.service<br>[root@duduniao etcd]# scp etcd-3.service 10.4.7.123:/lib/systemd/system/etcd.service<br>[root@duduniao etcd]# scan_host.sh cmd -h 10.4.7.121 10.4.7.122 10.4.7.123 &quot;systemctl daemon-reload&quot;<br>10.4.7.122<br>10.4.7.123<br>10.4.7.121<br>[root@duduniao etcd]# scan_host.sh cmd -h 10.4.7.121 10.4.7.122 10.4.7.123 &quot;systemctl restart etcd &amp;&amp; systemctl enable etcd&quot;<br></code></pre></td></tr></table></figure>

<h3 id="2-3-3-客户端验证"><a href="#2-3-3-客户端验证" class="headerlink" title="2.3.3. 客户端验证"></a>2.3.3. 客户端验证</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 不加证书<br>root@ubuntu-1804-122:~# etcdctl --endpoints=10.4.7.121:2379 member list --write-out=table<br>&#123;&quot;level&quot;:&quot;warn&quot;,&quot;ts&quot;:&quot;2021-10-17T10:26:16.722Z&quot;,&quot;logger&quot;:&quot;etcd-client&quot;,&quot;caller&quot;:&quot;v3/retry_interceptor.go:62&quot;,&quot;msg&quot;:&quot;retrying of unary invoker failed&quot;,&quot;target&quot;:&quot;etcd-endpoints://0xc000318380/10.4.7.121:2379&quot;,&quot;attempt&quot;:0,&quot;error&quot;:&quot;rpc error: code = DeadlineExceeded desc = latest balancer error: last connection error: connection closed&quot;&#125;<br>Error: context deadline exceeded<br><br># 加上证书<br>root@ubuntu-1804-122:~# cd /data/etcd/ssl/ &amp;&amp; etcdctl --cacert ca.pem --cert server.pem --key server-key.pem --endpoints https://10.4.7.121:2379 member list<br>4fe2b98ed7b794f7, started, etcd-3, https://10.4.7.123:2380, https://10.4.7.123:2379, false<br>bbd6739258f69625, started, etcd-1, https://10.4.7.121:2380, https://10.4.7.121:2379, false<br>c5542f3740ec56cd, started, etcd-2, https://10.4.7.122:2380, https://10.4.7.122:2379, false<br></code></pre></td></tr></table></figure>

<h2 id="2-4-etcd命令行"><a href="#2-4-etcd命令行" class="headerlink" title="2.4. etcd命令行"></a>2.4. etcd命令行</h2><h3 id="2-4-1-etcd"><a href="#2-4-1-etcd" class="headerlink" title="2.4.1. etcd"></a>2.4.1. etcd</h3><p>ectd 启动参数非常多，核心的启动参数有以下部分，其它请参考<a target="_blank" rel="noopener" href="https://etcd.io/docs/v3.5/op-guide/configuration/">官方文档</a>。</p>
<ul>
<li>member flgas</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plain">-name 						节点名称,用于组建集群，默认 default<br>-data-dir 				数据存储目录，默认工作目录下 $&#123;name&#125;.etcd<br>-wal-dir					wal日志目录，默认为data-dir<br>-snapshot-count		触发snapshot的事务提交次数，默认值 100000<br>-listen-peer-urls	集群节点中间对等网络监听URL，可以是http也可以是https, 0.0.0.0表示所有地址。默认 http://localhost:2380<br>-listen-peer-urls 用于暴露给客户端的URL地址，可以是http也可以是https, 0.0.0.0表示所有地址。默认 http://localhost:2379<br><br>–max-request-bytes	客户端最大请求的字节数，默认1572864<br>-quota-backend-bytes后端配额大小，默认为2G.最大为8G，超过会导致数据无法写入<br></code></pre></td></tr></table></figure>

<ul>
<li>cluster flags</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">–initial-cluster							引导并初始化一个新集群。仅在启动新的集群成员时生效，后续运行中会忽略该参数<br>–initial-advertise-peer-urls	对外发布peer节点通信地址。仅在启动新的集群成员时生效，后续运行中会忽略该参数<br>-initial-cluster-state				集群状态。new:表示所有节点都是第一次启动并组建集群;existing表示加入一个已存在的集群。仅在启动新的集群成员时生效，后续运行中会忽略该参数<br>-initial-cluster-token				集群的token，所有节点启动时需要指定。默认为 etcd-cluster。仅在启动新的集群成员时生效，后续运行中会忽略该参数<br>-advertise-client-urls				发布给其它成员，告知他们当前节点暴露给客户端的地址。默认为 http://localhost:2379<br></code></pre></td></tr></table></figure>

<ul>
<li>secirity flags</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plain">-trusted-ca-file				# 服务端信任的CA证书，用来验证客户端是否合法<br>-cert-file							# 服务端证书，由信任的CA签发，加密与客户端的通信，并且被客户端验证<br>-key-file								# 服务端证书私钥<br>-client-cert-auth				# 启用该参数表示服务端验证客户端证书是否为受信任的CA签发<br><br>–peer-trusted-ca-file		# peer节点通信信任的CA证书，用来验证其它节点是否合法<br>-peer-cert-file					# peer节点证书，由信任的CA签发，加密与客户端的通信，并且被其它节点验证<br>-peer-key-file					# peer节点证书私钥<br>-peer-client-cert-auth	# 启用该参数表示验证对端证书是否为受信任的CA签发<br></code></pre></td></tr></table></figure>

<ul>
<li>logging flags</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">-log-level	指定日志级别，默认info.可选: debug, info, warn, error, panic, fatal<br></code></pre></td></tr></table></figure>

<h3 id="2-4-2-etcdctl"><a href="#2-4-2-etcdctl" class="headerlink" title="2.4.2. etcdctl"></a>2.4.2. etcdctl</h3><h4 id="2-4-2-1-常用参数"><a href="#2-4-2-1-常用参数" class="headerlink" title="2.4.2.1. 常用参数"></a>2.4.2.1. 常用参数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">--endpoints	指定服务端GRPC接口，默认 127.0.0.1:2379<br><br>--cacert		指定ca证书，用来验证服务端是否合法<br>--cert			指定客户端证书<br>--key				指定客户端证书的私钥<br></code></pre></td></tr></table></figure>

<p>对于需要通过证书访问的场景，可以配置命令的别名，以下的案例均使用别名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">alias etc=&#x27;etcdctl --cacert ssl/ca.pem --cert ssl/client.pem --key ssl/client-key.pem --endpoints https://10.4.7.121:2379&#x27;<br></code></pre></td></tr></table></figure>

<h4 id="2-4-2-2-常用指令"><a href="#2-4-2-2-常用指令" class="headerlink" title="2.4.2.2. 常用指令"></a>2.4.2.2. 常用指令</h4><p>etcdctl 是etcd的客户端工具，通常用来查询集群和节点状态，偶尔用来查询指定key的值。</p>
<ol>
<li>指定API版本</li>
</ol>
<p>etcd的API有v2和v3，etcdctl 命令在3.4之前默认为v2，之后为v3。v2和v3版本的API数据不兼容，在查询的时候需要通过环境变量指定版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">export ETCDCTL_API=3  # 指定v3版本<br>export ETCDCTL_API=2	# 指定v2版本<br></code></pre></td></tr></table></figure>

<ol>
<li>写入key</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@duduniao etcd]# etc put key-1 value-1<br>[root@duduniao etcd]# etc put key-2 value-2<br>[root@duduniao etcd]# etc put key-3 value-3<br></code></pre></td></tr></table></figure>

<ol>
<li>查询key</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 精确查询<br>[root@duduniao etcd]# etc get key-1<br># 根据前缀查询<br>[root@duduniao etcd]# etc get --prefix key<br># 只显示value<br>[root@duduniao etcd]# etc get --prefix key --print-value-only<br># 现在查询结果的数量<br>[root@duduniao etcd]# etc get --prefix key --limit 2<br></code></pre></td></tr></table></figure>

<ol>
<li>watch key</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@duduniao etcd]# etc watch key-1<br></code></pre></td></tr></table></figure>

<ol>
<li>删除key</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@duduniao etcd]# etc del key-watch<br></code></pre></td></tr></table></figure>

<ol>
<li>查看集群状态</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@duduniao etcd]# etc member list --write-out=table<br>+------------------+---------+--------+-------------------------+-------------------------+------------+<br>|        ID        | STATUS  |  NAME  |       PEER ADDRS        |      CLIENT ADDRS       | IS LEARNER |<br>+------------------+---------+--------+-------------------------+-------------------------+------------+<br>| 4fe2b98ed7b794f7 | started | etcd-3 | https://10.4.7.123:2380 | https://10.4.7.123:2379 |      false |<br>| bbd6739258f69625 | started | etcd-1 | https://10.4.7.121:2380 | https://10.4.7.121:2379 |      false |<br>| c5542f3740ec56cd | started | etcd-2 | https://10.4.7.122:2380 | https://10.4.7.122:2379 |      false |<br>+------------------+---------+--------+-------------------------+-------------------------+------------+<br></code></pre></td></tr></table></figure>

<ol>
<li>查看节点状态</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@duduniao etcd]# etc endpoint status --write-out=table<br>+-------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+<br>|        ENDPOINT         |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |<br>+-------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+<br>| https://10.4.7.121:2379 | bbd6739258f69625 |   3.5.1 |   20 kB |      true |      false |         2 |         23 |                 23 |        |<br>+-------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+<br>[root@duduniao etcd]# etc endpoint health --write-out=table<br>+-------------------------+--------+----------+-------+<br>|        ENDPOINT         | HEALTH |   TOOK   | ERROR |<br>+-------------------------+--------+----------+-------+<br>| https://10.4.7.121:2379 |   true | 6.6739ms |       |<br>+-------------------------+--------+----------+-------+<br></code></pre></td></tr></table></figure>

<h3>原文来自：运维渡渡鸟</h3>
-----------------

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" class="category-chain-item">云原生</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9FEtcd/" class="print-no-link">#云原生Etcd</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Etcd概念及安装</div>
      <div>https://blog.t-ao.cn/2025/03/19/Etcd概念及安装/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>TAO</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月19日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/03/19/containerd%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%A4%87%E4%BB%BD/" title="containerd配置文件备份">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">containerd配置文件备份</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/19/Etcd%E9%9B%86%E7%BE%A4%E7%BB%B4%E6%8A%A4/" title="Etcd集群维护">
                        <span class="hidden-mobile">Etcd集群维护</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
